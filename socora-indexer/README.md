# Socora Indexer

The Socora indexer turns crawler artifacts into retrieval-ready knowledge stores using [LlamaIndex](https://www.llamaindex.ai/). It ingests normalized page content, builds embeddings, and exposes query interfaces for downstream agents and applications.

## Goals
- Transform `socora-crawler` outputs into structured document nodes with rich metadata.
- Support incremental indexing and change detection to keep civic data fresh.
- Provide reusable pipelines for retrieval-augmented generation (RAG) workloads across municipalities and agencies.

## Project Layout
- `main.py` - entry point for prototyping index builds and ad-hoc experiments.
- `pyproject.toml` - uv-managed dependency list (LlamaIndex, vector backends, utilities).
- `.venv/` - optional virtual environment created by uv.

## Setup
```powershell
uv sync
```
Bring your own OpenSearch endpoint and Ollama embedding host, then export credentials as needed (for example `OPENSEARCH_PASSWORD`, `OLLAMA_HOST`, etc.).

## Running
```powershell
uv run python main.py `
  --run-dir ..\output\run-20250920-220348 `
  --opensearch-endpoint https://localhost:9200 `
  --opensearch-index socora-cresskill `
  --opensearch-username admin `
  --opensearch-password ****** `
  --ollama-base-url http://localhost:11434 `
  --opensearch-option verify_certs=false
```
Arguments:
- `--run-dir` (required) - path to a crawler run that contains per-page `content.md` with front matter.
- `--opensearch-endpoint` (required) - OpenSearch URL that has a vector-enabled index.
- `--opensearch-index` (required) - target OpenSearch index name; created automatically if missing.
- `--opensearch-username` / `--opensearch-password` - optional basic-auth credentials.
- `--opensearch-option` - repeatable `key=value` overrides passed to the OpenSearch client (e.g. `verify_certs=false`).
- `--ollama-base-url` - Ollama host serving the `nomic-embed-text` embeddings model.
- `--ollama-model` - Ollama model identifier (defaults to `nomic-embed-text`).
- `--embed-batch-size` - batch size for embedding calls (<= 2048 for `nomic-embed-text`).
- `--semantic-buffer-size` / `--semantic-breakpoint-percentile` - controls semantic chunking behaviour.
- `--embedding-dimension` - embedding dimensionality expected by the OpenSearch index (768 for `nomic-embed-text`).
- `--metadata` - repeatable `key=value` pairs appended to every node's metadata.
The CLI will automatically provision the OpenSearch index if it does not exist, using kNN vector settings and keyword-friendly metadata mappings (see `socora_indexer.opensearch_utils`).

Front matter from each `content.md` file is preserved as node metadata, enabling downstream filters on properties such as `url`, `run_id`, or custom crawler annotations.

## Data Contracts
Crawler outputs consumed by the indexer live under `../output/run-*/` and include:
- `metadata.json` - page URL, final URL, status, timestamps, detected content type, downloaded file references.
- `content.json` - ordered DOM content with text and embed metadata.
- `content.md` - normalized Markdown generated by the normalization script.

Future revisions will publish a formal schema document to keep contracts stable across modules.

## Roadmap
1. Support streaming ingestion from cloud object storage.
2. Integrate vector databases (Qdrant, Weaviate, or OpenSearch vector extensions).
3. Ship evaluation harnesses that measure recall and answer quality for civic queries.
4. Expose gRPC/HTTP services for the Socora assistant and dashboard.

Contributions are welcome; add documentation when introducing new pipelines or configuration options.
